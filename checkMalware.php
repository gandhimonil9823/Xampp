<?php
include 'OfficialAdministrator.php';
if (isset ( $_FILES ['uploaded_file'] )) 
{	
	$damage = array ();
	$fileName = $_FILES ['uploaded_file'] ['name'];
	
	$size = $_FILES ['uploaded_file'] ['size'];
	$type = $_FILES ['uploaded_file'] ['type'];
	//10MB
	if ($file_size > 10485760) {
		$damage [] = 'File must be equal to 2 MB';
	}
   require_once 'login.php';
	//create a sql connection
	$conn = new mysqli ( $hn, $un, $pw, $db );
	if ($conn->connect_error) {
		die ( $conn->connect_error );
	}
	//we upload the bytes from the file into the db
	$uploadToDB = bytesInFile ( $fileName, $size );	
	//checking malware is in database with this function
	checkingMalware ($conn, $uploadToDB );
}
	
	function checkingMalware( $connection, $dbUpload) {
		//query that selects all malware from the users in the db
		$query = "SELECT * FROM Users.malware";
		$result = $connection->query ( $query );
		$number = $result->num_rows;
	    if (!$result)
			die ( $connection->error );
			while ($row = mysqli_fetch_array($result, MYSQLI_NUM )) 
			{	
		  	if(strpos($row[1], $dbUpload) !== false)
			{
				echo "<p> <font size=6 color=black>Infected file:</font></p> " . "\n";		
				echo "<p> <font size=6 color=black>". $dbUpload ."</font></p>";			
			}
		}
	
	}
	//getting the bytes from the files
	function bytesInFile($file, $size) {
		//the signature of the file
		$sig = "";
		if ($handle = fopen ( $file, 'r' )) {
			$contents_inside = fread ( $handle, $size );
			for($j = 0; $j < $size; $j ++) {
				$ascii = $contents_inside [$j];
				$DecimalBase = ord ( $ascii );
				$baseHex = base_convert ( $DecimalBase, 10, 16 );
				$sig .= $baseHex;
			}
			fclose ($handle);
			$startOfFinal = substr($sig, 0,20);
			return $startOfFinal;
		} else
			echo "<p> <font size=6 color=black>No permission</font></p>";
	}



?>
